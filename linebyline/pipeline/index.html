
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.3">
    
    
      
        <title>Tutorials - linebyline</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.edf004c2.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorials" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="linebyline" class="md-header__button md-logo" aria-label="linebyline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            linebyline
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorials
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="linebyline" class="md-nav__button md-logo" aria-label="linebyline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    linebyline
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Tutorials
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-0-imports-and-the-configuration-file" class="md-nav__link">
    Step 0: Imports and the configuration file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-correcting-for-known-systematics" class="md-nav__link">
    Step 1: Correcting for known systematics
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Correcting for known systematics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#harps" class="md-nav__link">
    HARPS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maroon-x" class="md-nav__link">
    MAROON-X
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-line-by-line-measurements" class="md-nav__link">
    Step 2: Line-by-line measurements
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Line-by-line measurements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-filtering-the-spectra" class="md-nav__link">
    a. Filtering the spectra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-building-a-reference-spectrum" class="md-nav__link">
    b. Building a reference spectrum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-generating-or-importing-a-catalog-of-spectral-lines" class="md-nav__link">
    c. Generating (or importing) a catalog of spectral lines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-making-the-measurements" class="md-nav__link">
    d. Making the measurements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e-filtering" class="md-nav__link">
    e. Filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f-saving" class="md-nav__link">
    f. Saving
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-processing-the-measurements" class="md-nav__link">
    Step 3: Processing the measurements
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        Configuration file
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-0-imports-and-the-configuration-file" class="md-nav__link">
    Step 0: Imports and the configuration file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-correcting-for-known-systematics" class="md-nav__link">
    Step 1: Correcting for known systematics
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Correcting for known systematics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#harps" class="md-nav__link">
    HARPS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maroon-x" class="md-nav__link">
    MAROON-X
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-line-by-line-measurements" class="md-nav__link">
    Step 2: Line-by-line measurements
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Line-by-line measurements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-filtering-the-spectra" class="md-nav__link">
    a. Filtering the spectra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-building-a-reference-spectrum" class="md-nav__link">
    b. Building a reference spectrum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-generating-or-importing-a-catalog-of-spectral-lines" class="md-nav__link">
    c. Generating (or importing) a catalog of spectral lines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-making-the-measurements" class="md-nav__link">
    d. Making the measurements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e-filtering" class="md-nav__link">
    e. Filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f-saving" class="md-nav__link">
    f. Saving
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-processing-the-measurements" class="md-nav__link">
    Step 3: Processing the measurements
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="tutorials">Tutorials</h1>
<p>Here we walk through the <tt>linebyline</tt> pipeline and highlight available features. A Jupyter notebook version of this tutorial is available at:</p>
<pre><code>linebyline/docs/tutorials/
</code></pre>
<p>For more details on each step and what parameters the user can change, see the configuration file page.</p>
<h2 id="step-0-imports-and-the-configuration-file">Step 0: Imports and the configuration file</h2>
<p>We first must navigate to the following directory:</p>
<pre><code>linebyline/docs/tutorials
</code></pre>
<p>For this tutorial, the following imports are necessary.</p>
<pre><code>import os
from linebyline.instruments import instrument
from linebyline.specbatch import SpecBatch
from linebyline.configs import config
from linebyline.parse import ParseSpec
</code></pre>
<p>To specify the default parameters for the pipeline, we also need to define a configuration file (see the configuration file page for details on the different parameters):</p>
<pre><code>cfg = config.get_config('../../linebyline/configs/extraction_config.ini')
</code></pre>
<h2 id="step-1-correcting-for-known-systematics">Step 1: Correcting for known systematics</h2>
<p>In this first step, the user provides a list of paths to stellar spectra and specifies the corresponding instrument; depending on the instrument, the user may also need to provide paths to the blaze correction files and the cross-correlation function (CCF) files. Given these user inputs, <tt>linebyline</tt> will load in the provided spectra and correct each for known systematics, including blaze corrections and Doppler shifting the wavelength solution into the heliocentric frame. </p>
<p>In this step, we also specify filters on airmass and activity level (see the configuration file page for details on the available filters).</p>
<p>Below we outline this step for each supported instrument.</p>
<h3 id="harps">HARPS</h3>
<p>Once in the , we first gather the stellar spectra:</p>
<pre><code>ps    = os.listdir('../example_data/HARPS/alphaCenB/spectra')
paths = ['../example_data/HARPS/alphaCenB/spectra/' + p for p in ps]
</code></pre>
<p>We then build two dictionaries that point to each spectra's corresponding blaze and CCF file:</p>
<pre><code>blaze_key = {}
for p in paths:
    blaze_key[p] = '../example_data/HARPS/alphaCenB/blaze/' + fits.open(p)[0].header['HIERARCH ESO DRS BLAZE FILE']
ccf_key = {}
for p in paths:
    ccf_key[p] = '../example_data/HARPS/alphaCenB/ccf/' + p.split('/')[-1].replace('_e2ds_A','_ccf_K5_A')
</code></pre>
<p>Lastly, we must initialize the instrument object with these paths and dictionaries,</p>
<pre><code>obs = instrument.HARPS(paths, blaze_key, cfg, ccf_key)
</code></pre>
<p>The instrument object <tt>obs</tt> can now be passed to the next step in the pipeline and will facilitate loading in the stellar spectra and correcting for known systematics. </p>
<h3 id="maroon-x">MAROON-X</h3>
<p>For MAROON-X, we initialize the instrument object as,</p>
<pre><code>obs = instrument.MAROONX(paths, blaze_key, cfg)
</code></pre>
<p>Notice, <tt>ccf_key</tt>  is no longer required.</p>
<h2 id="step-2-line-by-line-measurements">Step 2: Line-by-line measurements</h2>
<p>Next, we implement the line-by-line technique outlined by <a href="https://ui.adsabs.harvard.edu/abs/2018A%26A...620A..47D/abstract" target="_blank">Dumusque (2018)</a>.  Note, for here on, the pipeline is agnostic to the chosen instrument (the instrument object we defined in Step 1 will handle all instrument specific concerns).</p>
<p>To begin, we define the <tt>SpecBatch</tt> object,</p>
<pre><code>batch = SpecBatch(
    obs,
    target = target,
    config = cfg
)
</code></pre>
<p>where <tt>obs</tt> and <tt>cfg</tt>  were defined above, and <tt>target</tt> is a string that will be the name of the directory for saving the results. </p>
<p>We must then load all the input stellar spectra,</p>
<pre><code>batch.load_spectra()
</code></pre>
<p>and normalize their continuums (using a rolling maximum),</p>
<pre><code>batch.normalize_spectral_orders()
</code></pre>
<h4 id="a-filtering-the-spectra">a. Filtering the spectra</h4>
<p>Before proceeding further, we must remove outlier observations from the input stellar spectra. <tt>linebyline</tt> filters observations based on the slope of each spectral orders continuum,</p>
<pre><code>batch.filter_for_continuum()
</code></pre>
<p>The user can specify additional filters, by controlling the list of paths passed to <tt>linebyline</tt> . </p>
<h4 id="b-building-a-reference-spectrum">b. Building a reference spectrum</h4>
<p>Next, we build a reference spectrum form the input stellar spectra. </p>
<pre><code>batch.create_master()
</code></pre>
<p>To help with memory usage, next call</p>
<pre><code>batch.flush()
</code></pre>
<p>to remove the loaded spectra from active memory (we don't need to have them all loaded at once now that we have the reference spectrum).</p>
<h4 id="c-generating-or-importing-a-catalog-of-spectral-lines">c. Generating (or importing) a catalog of spectral lines</h4>
<p>To conduct the line-by-line measurements, we need a catalog of spectral lines. This catalog can either be generated based on the reference spectrum or imported from a user specified file.</p>
<p>To specify a list of spectral lines, set the <tt>template</tt> parameter for <tt>batch.fetch_template </tt> to a path to the line list.  User defined line lists must have the same format as the ESPRESSO line lists. Examples for the K5 and G2 stellar types are provided in,</p>
<pre><code>linebyline/docs/example_data/synthetic_templates
</code></pre>
<p>For example, to use the ESPRESSO K5 template,</p>
<pre><code>batch.fetch_template(template='../example_data/synthetic_templates/K5.mas')
</code></pre>
<p>Alternatively, to have the catalog generated from the reference spectrum, set <tt>template='auto'</tt> and call,</p>
<pre><code>batch.fetch_template(template='auto')
</code></pre>
<p>Regardless of whether the line list is generated from the reference spectra or user specified, we next want to flag potentially contaminated lines, including those near tellurics or near stichings in the CCD:</p>
<pre><code>batch.flag_telluric_TAPAS('../example_data/TAPAS/TAPAS_WMKO_NORAYLEIGH_SPEC')
batch.flag_crossover()
</code></pre>
<p>where we have pointed to an example TAPAS atmospheric spectrum for  <tt>batch.flag_telluric_TAPAS</tt>.</p>
<h4 id="d-making-the-measurements">d. Making the measurements</h4>
<p>We're now ready to conduct the line-by-line measurements (yay!). This is handled by the following call,</p>
<pre><code> batch.fetch_LBL()
</code></pre>
<p>To help reduce run-times, the user can specify the number of processors to use.</p>
<h4 id="e-filtering">e. Filtering</h4>
<p>Lastly, we flag outlier line-by-line measurements,</p>
<pre><code>batch.filter_LBL()
</code></pre>
<h4 id="f-saving">f. Saving</h4>
<p>To save our results, we run,</p>
<pre><code>batch.save_template()
batch.save_LBL_data()
batch.save_master()
</code></pre>
<h2 id="step-3-processing-the-measurements">Step 3: Processing the measurements</h2>
<p>Now that we have made the line-by-line measurements, what can we do with them? </p>
<p>To start, we load the saved results into the <tt>ParseSpec</tt> object. </p>
<pre><code>dat = ParseSpec(target + '/')
</code></pre>
<p>where <tt>target</tt> is the same specified in Step 2.</p>
<p>The line-by-line measurements are stored as <tt>pandas.DataFrame</tt> in <tt>dat.data</tt>.</p>
<p>We next reject flagged measurements (including lines contaminated by tellurics or rejected by the sigma clipping in Step 2f),</p>
<pre><code>dat.enforce_filter()
</code></pre>
<p>To calculate the bulk RV for each spectra, we run</p>
<pre><code>t,rv,er = dat.fetch_bulk_RVs(log=True)
</code></pre>
<p>where <tt>log=True</tt> saves the bulk RVs to <tt>dat.data</tt>.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        
        <a href="../config/" class="md-footer__link md-footer__link--next" aria-label="Next: Configuration file" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Configuration file
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.0bbba5b5.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.e1a181d9.min.js"></script>
      
    
  </body>
</html>